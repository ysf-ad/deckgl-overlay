{"version":3,"sources":["../../../src/terrain/terrain-effect.ts"],"names":["TerrainEffect","Map","gl","dummyHeightMap","Texture2D","width","height","data","Uint8Array","terrainPass","TerrainPass","id","terrainPickingPass","TerrainPickingPass","HeightMapBuilder","isSupported","heightMap","log","warn","ProgramManager","getDefaultProgramManager","addDefaultModule","terrainModule","opts","initialize","layers","layer","props","operation","includes","setChangeFlags","extensionsChanged","pickZ","isDrapingEnabled","viewports","isPicking","pass","startsWith","viewport","getRenderableLayers","terrainLayers","filter","l","length","offsetLayers","state","terrainDrawMode","_updateHeightMap","drapeLayers","_updateTerrainCovers","getRenderFramebuffer","heightMapBounds","bounds","terrainCover","terrainCovers","get","useTerrainHeightMap","terrainSkipRender","delete","undefined","values","clear","shouldUpdate","renderHeightMap","moduleParameters","devicePixelRatio","drawToTerrainHeightMap","layerNeedsRedraw","terrainCoverNeedsRedraw","isDirty","_updateTerrainCover","_pruneTerrainCovers","terrainLayer","renderPass","TerrainCover","set","targetLayer","renderTerrainCover","err","raiseError","idsToRemove","isActive","push"],"mappings":"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","sourcesContent":["import {Texture2D, ProgramManager} from '@luma.gl/core';\nimport {log} from '@deck.gl/core';\n\nimport {terrainModule, TerrainModuleSettings} from './shader-module';\nimport {TerrainCover} from './terrain-cover';\nimport {TerrainPass} from './terrain-pass';\nimport {TerrainPickingPass, TerrainPickingPassRenderOptions} from './terrain-picking-pass';\nimport {HeightMapBuilder} from './height-map-builder';\n\nimport type {Effect, PreRenderOptions, Layer, Viewport} from '@deck.gl/core';\n\n/** Class to manage terrain effect */\nexport class TerrainEffect implements Effect {\n  id = 'terrain-effect';\n  props = null;\n  useInPicking = true;\n\n  /** true if picking in the current pass */\n  private isPicking: boolean = false;\n  /** true if should use in the current pass */\n  private isDrapingEnabled: boolean = false;\n  /** An empty texture as placeholder */\n  private dummyHeightMap: Texture2D;\n  /** A texture encoding the ground elevation, updated once per redraw. Used by layers with offset mode */\n  private heightMap?: HeightMapBuilder;\n  private terrainPass!: TerrainPass;\n  private terrainPickingPass!: TerrainPickingPass;\n  /** One texture for each primitive terrain layer, into which the draped layers render */\n  private terrainCovers: Map<string, TerrainCover> = new Map();\n\n  initialize(gl: WebGLRenderingContext) {\n    this.dummyHeightMap = new Texture2D(gl, {\n      width: 1,\n      height: 1,\n      data: new Uint8Array([0, 0, 0, 0])\n    });\n    this.terrainPass = new TerrainPass(gl, {id: 'terrain'});\n    this.terrainPickingPass = new TerrainPickingPass(gl, {id: 'terrain-picking'});\n\n    if (HeightMapBuilder.isSupported(gl)) {\n      this.heightMap = new HeightMapBuilder(gl);\n    } else {\n      log.warn('Terrain offset mode is not supported by this browser')();\n    }\n\n    ProgramManager.getDefaultProgramManager(gl).addDefaultModule(terrainModule);\n  }\n\n  preRender(gl: WebGLRenderingContext, opts: PreRenderOptions): void {\n    if (!this.dummyHeightMap) {\n      // First time this effect is in use, initialize resources and register the shader module\n      this.initialize(gl);\n      for (const layer of opts.layers) {\n        // Force the terrain layer (and its descendents) to rebuild their models with the new shader\n        if (layer.props.operation.includes('terrain')) {\n          layer.setChangeFlags({extensionsChanged: true});\n        }\n      }\n    }\n\n    // @ts-expect-error pickZ only defined in picking pass\n    if (opts.pickZ) {\n      // Do not update if picking attributes\n      this.isDrapingEnabled = false;\n      return;\n    }\n\n    const {viewports} = opts;\n    const isPicking = opts.pass.startsWith('picking');\n    this.isPicking = isPicking;\n    this.isDrapingEnabled = true;\n\n    // TODO - support multiple views?\n    const viewport = viewports[0];\n    const layers = (isPicking ? this.terrainPickingPass : this.terrainPass).getRenderableLayers(\n      viewport,\n      opts as TerrainPickingPassRenderOptions\n    );\n\n    const terrainLayers = layers.filter(l => l.props.operation.includes('terrain'));\n    if (terrainLayers.length === 0) {\n      return;\n    }\n\n    if (!isPicking) {\n      const offsetLayers = layers.filter(l => l.state.terrainDrawMode === 'offset');\n      if (offsetLayers.length > 0) {\n        this._updateHeightMap(terrainLayers, viewport, opts);\n      }\n    }\n\n    const drapeLayers = layers.filter(l => l.state.terrainDrawMode === 'drape');\n    this._updateTerrainCovers(terrainLayers, drapeLayers, viewport, opts);\n  }\n\n  getModuleParameters(layer: Layer): TerrainModuleSettings {\n    const {terrainDrawMode} = layer.state;\n\n    return {\n      heightMap: this.heightMap?.getRenderFramebuffer(),\n      heightMapBounds: this.heightMap?.bounds,\n      dummyHeightMap: this.dummyHeightMap,\n      terrainCover: this.isDrapingEnabled ? this.terrainCovers.get(layer.id) : null,\n      useTerrainHeightMap: terrainDrawMode === 'offset',\n      terrainSkipRender: terrainDrawMode === 'drape' || !layer.props.operation.includes('draw')\n    };\n  }\n\n  cleanup(): void {\n    if (this.dummyHeightMap) {\n      this.dummyHeightMap.delete();\n      this.dummyHeightMap = undefined;\n    }\n\n    if (this.heightMap) {\n      this.heightMap.delete();\n      this.heightMap = undefined;\n    }\n\n    for (const terrainCover of this.terrainCovers.values()) {\n      terrainCover.delete();\n    }\n    this.terrainCovers.clear();\n  }\n\n  private _updateHeightMap(terrainLayers: Layer[], viewport: Viewport, opts: PreRenderOptions) {\n    if (!this.heightMap) {\n      // Not supported\n      return;\n    }\n\n    const shouldUpdate = this.heightMap.shouldUpdate({layers: terrainLayers, viewport});\n    if (!shouldUpdate) {\n      return;\n    }\n\n    this.terrainPass.renderHeightMap(this.heightMap, {\n      ...opts,\n      layers: terrainLayers,\n      moduleParameters: {\n        heightMapBounds: this.heightMap.bounds,\n        dummyHeightMap: this.dummyHeightMap,\n        devicePixelRatio: 1,\n        drawToTerrainHeightMap: true\n      }\n    });\n  }\n\n  private _updateTerrainCovers(\n    terrainLayers: Layer[],\n    drapeLayers: Layer[],\n    viewport: Viewport,\n    opts: PreRenderOptions\n  ) {\n    // Mark a terrain cover as dirty if one of the drape layers needs redraw\n    const layerNeedsRedraw: Record<string, boolean> = {};\n    for (const layer of drapeLayers) {\n      if (layer.state.terrainCoverNeedsRedraw) {\n        layerNeedsRedraw[layer.id] = true;\n        layer.state.terrainCoverNeedsRedraw = false;\n      }\n    }\n    for (const terrainCover of this.terrainCovers.values()) {\n      terrainCover.isDirty = terrainCover.isDirty || terrainCover.shouldUpdate({layerNeedsRedraw});\n    }\n\n    for (const layer of terrainLayers) {\n      this._updateTerrainCover(layer, drapeLayers, viewport, opts);\n    }\n\n    if (!this.isPicking) {\n      this._pruneTerrainCovers();\n    }\n  }\n\n  private _updateTerrainCover(\n    terrainLayer: Layer,\n    drapeLayers: Layer[],\n    viewport: Viewport,\n    opts: PreRenderOptions\n  ) {\n    const renderPass = this.isPicking ? this.terrainPickingPass : this.terrainPass;\n    let terrainCover = this.terrainCovers.get(terrainLayer.id);\n    if (!terrainCover) {\n      terrainCover = new TerrainCover(terrainLayer);\n      this.terrainCovers.set(terrainLayer.id, terrainCover);\n    }\n    try {\n      const isDirty = terrainCover.shouldUpdate({\n        targetLayer: terrainLayer,\n        viewport,\n        layers: drapeLayers\n      });\n      if (this.isPicking || terrainCover.isDirty || isDirty) {\n        renderPass.renderTerrainCover(terrainCover, {\n          ...opts,\n          layers: drapeLayers,\n          moduleParameters: {\n            dummyHeightMap: this.dummyHeightMap,\n            terrainSkipRender: false,\n            devicePixelRatio: 1\n          }\n        });\n\n        if (!this.isPicking) {\n          // IsDirty refers to the normal fbo, not the picking fbo.\n          // Only mark it as not dirty if the normal fbo was updated.\n          terrainCover.isDirty = false;\n        }\n      }\n    } catch (err) {\n      terrainLayer.raiseError(err as Error, `Error rendering terrain cover ${terrainCover.id}`);\n    }\n  }\n\n  private _pruneTerrainCovers() {\n    /** Prune the cache, remove textures for layers that have been removed */\n    const idsToRemove: string[] = [];\n    for (const [id, terrainCover] of this.terrainCovers) {\n      if (!terrainCover.isActive) {\n        idsToRemove.push(id);\n      }\n    }\n    for (const id of idsToRemove) {\n      this.terrainCovers.delete(id);\n    }\n  }\n}\n"],"file":"terrain-effect.js"}