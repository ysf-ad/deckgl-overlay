{"version":3,"file":"tiles-3d-loader.js","names":["_loaderUtils","require","_tiles","_version","_parse3dTile","_parse3dTileHeader","Tiles3DLoader","id","name","module","version","VERSION","extensions","mimeTypes","tests","parse","options","loadGLTF","decodeQuantizedPositions","isTileset","assetGltfUpAxis","exports","getBaseUri","tileset","path","dirname","url","parseTile","arrayBuffer","context","tile","content","featureIds","byteOffset","parse3DTile","parseTileset","data","_tilesetJson$root","tilesetJson","JSON","TextDecoder","decode","loader","queryString","basePath","root","normalizeTileHeaders","type","TILESET_TYPE","TILES3D","lodMetricType","LOD_METRIC_TYPE","GEOMETRIC_ERROR","lodMetricValue","loaderOptions","indexOf"],"sources":["../../src/tiles-3d-loader.ts"],"sourcesContent":["import type {LoaderWithParser} from '@loaders.gl/loader-utils';\nimport {path} from '@loaders.gl/loader-utils';\nimport {TILESET_TYPE, LOD_METRIC_TYPE} from '@loaders.gl/tiles';\nimport {VERSION} from './lib/utils/version';\nimport {parse3DTile} from './lib/parsers/parse-3d-tile';\nimport {normalizeTileHeaders} from './lib/parsers/parse-3d-tile-header';\n\n/**\n * Loader for 3D Tiles\n */\nexport const Tiles3DLoader: LoaderWithParser = {\n  id: '3d-tiles',\n  name: '3D Tiles',\n  module: '3d-tiles',\n  version: VERSION,\n  extensions: ['cmpt', 'pnts', 'b3dm', 'i3dm'],\n  mimeTypes: ['application/octet-stream'],\n  tests: ['cmpt', 'pnts', 'b3dm', 'i3dm'],\n  parse,\n  options: {\n    '3d-tiles': {\n      loadGLTF: true,\n      decodeQuantizedPositions: false,\n      isTileset: 'auto',\n      assetGltfUpAxis: null\n    }\n  }\n};\n\nfunction getBaseUri(tileset) {\n  return path.dirname(tileset.url);\n}\n\nasync function parseTile(arrayBuffer, options, context) {\n  const tile = {\n    content: {\n      featureIds: null\n    }\n  };\n  const byteOffset = 0;\n  await parse3DTile(arrayBuffer, byteOffset, options, context, tile.content);\n  return tile.content;\n}\n\nasync function parseTileset(data, options, context) {\n  const tilesetJson = JSON.parse(new TextDecoder().decode(data));\n  // eslint-disable-next-line no-use-before-define\n  tilesetJson.loader = options.loader || Tiles3DLoader;\n  tilesetJson.url = context.url;\n  tilesetJson.queryString = context.queryString;\n\n  // base path that non-absolute paths in tileset are relative to.\n  tilesetJson.basePath = getBaseUri(tilesetJson);\n  tilesetJson.root = await normalizeTileHeaders(tilesetJson, options);\n\n  tilesetJson.type = TILESET_TYPE.TILES3D;\n\n  tilesetJson.lodMetricType = LOD_METRIC_TYPE.GEOMETRIC_ERROR;\n  tilesetJson.lodMetricValue = tilesetJson.root?.lodMetricValue || 0;\n\n  return tilesetJson;\n}\n\nasync function parse(data, options, context) {\n  // auto detect file type\n  const loaderOptions = options['3d-tiles'] || {};\n  let isTileset;\n  if (loaderOptions.isTileset === 'auto') {\n    isTileset = context.url && context.url.indexOf('.json') !== -1;\n  } else {\n    isTileset = loaderOptions.isTileset;\n  }\n\n  if (isTileset) {\n    data = await parseTileset(data, options, context);\n  } else {\n    data = await parseTile(data, options, context);\n  }\n\n  return data;\n}\n"],"mappings":"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"}