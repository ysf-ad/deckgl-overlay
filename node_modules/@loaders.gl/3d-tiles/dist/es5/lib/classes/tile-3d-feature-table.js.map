{"version":3,"file":"tile-3d-feature-table.js","names":["_math","require","Tile3DFeatureTable","constructor","featureTableJson","featureTableBinary","_defineProperty2","default","json","buffer","getExtension","extensionName","extensions","hasProperty","propertyName","Boolean","getGlobalProperty","componentType","arguments","length","undefined","GL","UNSIGNED_INT","componentLength","jsonValue","Number","isFinite","byteOffset","_getTypedArrayFromBinary","getPropertyArray","GLType","fromName","featuresLength","_getTypedArrayFromArray","getProperty","featureId","result","typedArray","i","count","cachedTypedArrays","_cachedTypedArrays","createTypedArray","array","exports"],"sources":["../../../../src/lib/classes/tile-3d-feature-table.ts"],"sourcesContent":["// This file is derived from the Cesium code base under Apache 2 license\n// See LICENSE.md and https://github.com/AnalyticalGraphicsInc/cesium/blob/master/LICENSE.md\n\nimport {GL, GLType} from '@loaders.gl/math';\n\n// Reference:\n// https://github.com/AnalyticalGraphicsInc/cesium/blob/1de96d087f0b17575eb1a3f736407b348c765d59/Source/Scene/Cesium3DTileFeatureTable.js\nexport default class Tile3DFeatureTable {\n  json;\n  buffer;\n  featuresLength = 0;\n  _cachedTypedArrays = {};\n\n  constructor(featureTableJson, featureTableBinary) {\n    this.json = featureTableJson;\n    this.buffer = featureTableBinary;\n  }\n\n  getExtension(extensionName) {\n    return this.json.extensions && this.json.extensions[extensionName];\n  }\n\n  hasProperty(propertyName) {\n    return Boolean(this.json[propertyName]);\n  }\n\n  getGlobalProperty(propertyName, componentType = GL.UNSIGNED_INT, componentLength = 1) {\n    const jsonValue = this.json[propertyName];\n\n    if (jsonValue && Number.isFinite(jsonValue.byteOffset)) {\n      return this._getTypedArrayFromBinary(\n        propertyName,\n        componentType,\n        componentLength,\n        1,\n        jsonValue.byteOffset\n      );\n    }\n\n    return jsonValue;\n  }\n\n  getPropertyArray(propertyName, componentType, componentLength) {\n    const jsonValue = this.json[propertyName];\n\n    if (jsonValue && Number.isFinite(jsonValue.byteOffset)) {\n      if ('componentType' in jsonValue) {\n        componentType = GLType.fromName(jsonValue.componentType);\n      }\n      return this._getTypedArrayFromBinary(\n        propertyName,\n        componentType,\n        componentLength,\n        this.featuresLength,\n        jsonValue.byteOffset\n      );\n    }\n\n    return this._getTypedArrayFromArray(propertyName, componentType, jsonValue);\n  }\n\n  getProperty(propertyName, componentType, componentLength, featureId, result) {\n    const jsonValue = this.json[propertyName];\n    if (!jsonValue) {\n      return jsonValue;\n    }\n\n    const typedArray = this.getPropertyArray(propertyName, componentType, componentLength);\n\n    if (componentLength === 1) {\n      return typedArray[featureId];\n    }\n\n    for (let i = 0; i < componentLength; ++i) {\n      result[i] = typedArray[componentLength * featureId + i];\n    }\n\n    return result;\n  }\n\n  // HELPERS\n\n  _getTypedArrayFromBinary(propertyName, componentType, componentLength, count, byteOffset) {\n    const cachedTypedArrays = this._cachedTypedArrays;\n    let typedArray = cachedTypedArrays[propertyName];\n    if (!typedArray) {\n      typedArray = GLType.createTypedArray(\n        componentType,\n        this.buffer.buffer,\n        this.buffer.byteOffset + byteOffset,\n        count * componentLength\n      );\n      cachedTypedArrays[propertyName] = typedArray;\n    }\n    return typedArray;\n  }\n\n  _getTypedArrayFromArray(propertyName, componentType, array) {\n    const cachedTypedArrays = this._cachedTypedArrays;\n    let typedArray = cachedTypedArrays[propertyName];\n    if (!typedArray) {\n      typedArray = GLType.createTypedArray(componentType, array);\n      cachedTypedArrays[propertyName] = typedArray;\n    }\n    return typedArray;\n  }\n}\n"],"mappings":"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"}