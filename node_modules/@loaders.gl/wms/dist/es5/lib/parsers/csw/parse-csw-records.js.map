{"version":3,"file":"parse-csw-records.js","names":["_xml","require","_parseExceptionReport","parseCSWRecords","text","options","parsedXML","XMLLoader","parseTextSync","xml","removeNSPrefix","uncapitalizeKeys","arrayPaths","_fastXML","parseAttributeValue","parseExceptionReport","xmlRecords","getRecordsResponse","elementSet","searchResults","recordsFieldName","concat","records","convertXMLFieldToArrayInPlace","record","boundingBoxes","boundingBox","value","upperCorner","lowerCorner","renameXMLTags","renameKeys","oldKey","newKey","Object","entries"],"sources":["../../../../../src/lib/parsers/csw/parse-csw-records.ts"],"sourcesContent":["// loaders.gl, MIT license\n\nimport {XMLLoaderOptions, convertXMLFieldToArrayInPlace} from '@loaders.gl/xml';\nimport {XMLLoader} from '@loaders.gl/xml';\nimport {parseExceptionReport} from './parse-exception-report';\n\nexport type CSWRecords = {\n  searchStatus: {\n    timestamp?: string;\n  };\n  searchResults: {\n    numberOfRecordsMatched: number;\n    numberOfRecordsReturned: number;\n    elementSet: string;\n    nextRecord: number;\n  };\n  records: {\n    type: string;\n    title: string;\n    abstract: string;\n    subject: string[];\n    boundingBoxes: {\n      crs: string;\n      value: [number, number, number, number];\n    }[];\n    references: {\n      value: string;\n      scheme: string;\n    }[];\n  }[];\n};\n\n/**\n * Parses a typed data structure from raw XML for `GetRecords` response\n * @note Error handlings is fairly weak\n */\nexport function parseCSWRecords(text: string, options?: XMLLoaderOptions): CSWRecords {\n  const parsedXML = XMLLoader.parseTextSync(text, {\n    ...options,\n    xml: {\n      ...options?.xml,\n      removeNSPrefix: true,\n      uncapitalizeKeys: true,\n      arrayPaths: []\n    },\n    _fastXML: {\n      ...options?._fastXML,\n      parseAttributeValue: true\n    }\n  });\n\n  parseExceptionReport(parsedXML);\n\n  const xmlRecords: any = parsedXML.getRecordsResponse;\n\n  // Move results to top\n  const elementSet = xmlRecords.searchResults.elementSet;\n  const recordsFieldName = `${elementSet}Record`;\n  xmlRecords.records = xmlRecords.searchResults[recordsFieldName];\n  delete xmlRecords.searchResults[recordsFieldName];\n\n  convertXMLFieldToArrayInPlace(xmlRecords, 'records');\n\n  for (const record of xmlRecords.records) {\n    record.boundingBoxes = record.boundingBox;\n    delete record.boundingBox;\n\n    convertXMLFieldToArrayInPlace(record, 'boundingBoxes');\n\n    for (const boundingBox of record.boundingBoxes) {\n      boundingBox.value = [\n        boundingBox.upperCorner[0],\n        boundingBox.upperCorner[1],\n        boundingBox.lowerCorner[0],\n        boundingBox.lowerCorner[1]\n      ];\n      delete boundingBox.upperCorner;\n      delete boundingBox.lowerCorner;\n    }\n  }\n\n  return xmlRecords as CSWRecords;\n}\n\nexport function renameXMLTags(xml: any, renameKeys: Record<string, string>): void {\n  for (const [oldKey, newKey] of Object.entries(renameKeys)) {\n    xml[newKey] = xml[oldKey];\n    delete xml[oldKey];\n  }\n}\n"],"mappings":";;;;;;;AAEA,IAAAA,IAAA,GAAAC,OAAA;AAEA,IAAAC,qBAAA,GAAAD,OAAA;AAgCO,SAASE,eAAeA,CAACC,IAAY,EAAEC,OAA0B,EAAc;EACpF,MAAMC,SAAS,GAAGC,cAAS,CAACC,aAAa,CAACJ,IAAI,EAAE;IAC9C,GAAGC,OAAO;IACVI,GAAG,EAAE;MACH,IAAGJ,OAAO,aAAPA,OAAO,uBAAPA,OAAO,CAAEI,GAAG;MACfC,cAAc,EAAE,IAAI;MACpBC,gBAAgB,EAAE,IAAI;MACtBC,UAAU,EAAE;IACd,CAAC;IACDC,QAAQ,EAAE;MACR,IAAGR,OAAO,aAAPA,OAAO,uBAAPA,OAAO,CAAEQ,QAAQ;MACpBC,mBAAmB,EAAE;IACvB;EACF,CAAC,CAAC;EAEF,IAAAC,0CAAoB,EAACT,SAAS,CAAC;EAE/B,MAAMU,UAAe,GAAGV,SAAS,CAACW,kBAAkB;EAGpD,MAAMC,UAAU,GAAGF,UAAU,CAACG,aAAa,CAACD,UAAU;EACtD,MAAME,gBAAgB,MAAAC,MAAA,CAAMH,UAAU,WAAQ;EAC9CF,UAAU,CAACM,OAAO,GAAGN,UAAU,CAACG,aAAa,CAACC,gBAAgB,CAAC;EAC/D,OAAOJ,UAAU,CAACG,aAAa,CAACC,gBAAgB,CAAC;EAEjD,IAAAG,kCAA6B,EAACP,UAAU,EAAE,SAAS,CAAC;EAEpD,KAAK,MAAMQ,MAAM,IAAIR,UAAU,CAACM,OAAO,EAAE;IACvCE,MAAM,CAACC,aAAa,GAAGD,MAAM,CAACE,WAAW;IACzC,OAAOF,MAAM,CAACE,WAAW;IAEzB,IAAAH,kCAA6B,EAACC,MAAM,EAAE,eAAe,CAAC;IAEtD,KAAK,MAAME,WAAW,IAAIF,MAAM,CAACC,aAAa,EAAE;MAC9CC,WAAW,CAACC,KAAK,GAAG,CAClBD,WAAW,CAACE,WAAW,CAAC,CAAC,CAAC,EAC1BF,WAAW,CAACE,WAAW,CAAC,CAAC,CAAC,EAC1BF,WAAW,CAACG,WAAW,CAAC,CAAC,CAAC,EAC1BH,WAAW,CAACG,WAAW,CAAC,CAAC,CAAC,CAC3B;MACD,OAAOH,WAAW,CAACE,WAAW;MAC9B,OAAOF,WAAW,CAACG,WAAW;IAChC;EACF;EAEA,OAAOb,UAAU;AACnB;AAEO,SAASc,aAAaA,CAACrB,GAAQ,EAAEsB,UAAkC,EAAQ;EAChF,KAAK,MAAM,CAACC,MAAM,EAAEC,MAAM,CAAC,IAAIC,MAAM,CAACC,OAAO,CAACJ,UAAU,CAAC,EAAE;IACzDtB,GAAG,CAACwB,MAAM,CAAC,GAAGxB,GAAG,CAACuB,MAAM,CAAC;IACzB,OAAOvB,GAAG,CAACuB,MAAM,CAAC;EACpB;AACF"}