{"version":3,"file":"tileset-traverser.js","names":["_managedArray","require","_constants","DEFAULT_PROPS","loadSiblings","skipLevelOfDetail","maximumScreenSpaceError","updateTransforms","onTraversalEnd","viewportTraversersMap","basePath","exports","TilesetTraverser","traversalFinished","frameState","constructor","options","_defineProperty2","default","Date","getTime","ManagedArray","traverse","root","reset","updateTile","_frameNumber","frameNumber","executeTraversal","requestedTiles","selectedTiles","emptyTiles","_traversalStack","_emptyTraversalStack","stack","_selectionDepth","push","length","tile","pop","shouldRefine","canTraverse","updateChildTiles","updateAndPushChildren","hasRenderContent","parent","parentRefines","Boolean","_shouldRefine","stoppedRefining","id","loadTile","selectTile","refine","TILE_REFINEMENT","ADD","REPLACE","touchTile","newTime","lastUpdate","updateDebounceTime","children","child","depth","sort","compareDistanceToCamera","bind","checkRefines","hasVisibleChild","refines","isVisibleAndInRequestVolume","find","delete","childRefines","_inRequestVolume","executeEmptyTraversal","contentAvailable","updateTileVisibility","shouldSelectTile","_selectedFrame","shouldLoadTile","_requestedFrame","_priority","_getPriority","tileset","_cache","touch","_touchedFrame","useParentMetric","arguments","undefined","ignoreVisibility","hasChildren","hasTilesetContent","contentExpired","hasUnloadedContent","screenSpaceError","_screenSpaceError","getScreenSpaceError","viewportIds","key","value","viewport","updateVisibility","b","a","_distanceToCamera","anyChildrenVisible","anyVisible","allDescendantsLoaded","hasEmptyContent"],"sources":["../../../src/tileset/tileset-traverser.ts"],"sourcesContent":["// loaders.gl, MIT license\n\nimport type {Tile3D} from './tile-3d';\nimport {ManagedArray} from '../utils/managed-array';\nimport {TILE_REFINEMENT} from '../constants';\nimport {FrameState} from './helpers/frame-state';\n\nexport type TilesetTraverserProps = {\n  loadSiblings?: boolean;\n  skipLevelOfDetail?: boolean;\n  updateTransforms?: boolean;\n  maximumScreenSpaceError?: number;\n  onTraversalEnd?: (frameState) => any;\n  viewportTraversersMap?: Record<string, any>;\n  basePath?: string;\n};\n\nexport const DEFAULT_PROPS: Required<TilesetTraverserProps> = {\n  loadSiblings: false,\n  skipLevelOfDetail: false,\n  maximumScreenSpaceError: 2,\n  updateTransforms: true,\n  onTraversalEnd: () => {},\n  viewportTraversersMap: {},\n  basePath: ''\n};\n\nexport class TilesetTraverser {\n  options: Required<TilesetTraverserProps>;\n\n  // fulfill in traverse call\n  root: any = null;\n\n  // tiles should be rendered\n  selectedTiles: Record<string, Tile3D> = {};\n  // tiles should be loaded from server\n  requestedTiles: Record<string, Tile3D> = {};\n  // tiles does not have render content\n  emptyTiles: Record<string, Tile3D> = {};\n\n  protected lastUpdate: number = new Date().getTime();\n  protected readonly updateDebounceTime = 1000;\n  /** temporary storage to hold the traversed tiles during a traversal */\n  protected _traversalStack = new ManagedArray();\n  protected _emptyTraversalStack = new ManagedArray();\n  /** set in every traverse cycle */\n  protected _frameNumber: number | null = null;\n\n  // RESULT\n  protected traversalFinished(frameState: FrameState): boolean {\n    return true;\n  }\n\n  // TODO nested props\n  constructor(options: TilesetTraverserProps) {\n    this.options = {...DEFAULT_PROPS, ...options};\n  }\n\n  // tiles should be visible\n  traverse(root, frameState, options) {\n    this.root = root; // for root screen space error\n    this.options = {...this.options, ...options};\n\n    // reset result\n    this.reset();\n\n    // update tile (visibility and expiration)\n    this.updateTile(root, frameState);\n\n    this._frameNumber = frameState.frameNumber;\n    this.executeTraversal(root, frameState);\n  }\n\n  reset() {\n    this.requestedTiles = {};\n    this.selectedTiles = {};\n    this.emptyTiles = {};\n    this._traversalStack.reset();\n    this._emptyTraversalStack.reset();\n  }\n\n  /**\n   * Execute traverse\n   * Depth-first traversal that traverses all visible tiles and marks tiles for selection.\n   * If skipLevelOfDetail is off then a tile does not refine until all children are loaded.\n   * This is the traditional replacement refinement approach and is called the base traversal.\n   * Tiles that have a greater screen space error than the base screen space error are part of the base traversal,\n   * all other tiles are part of the skip traversal. The skip traversal allows for skipping levels of the tree\n   * and rendering children and parent tiles simultaneously.\n   */\n  /* eslint-disable-next-line complexity, max-statements */\n  executeTraversal(root, frameState: FrameState): void {\n    // stack to store traversed tiles, only visible tiles should be added to stack\n    // visible: visible in the current view frustum\n    const stack = this._traversalStack;\n    root._selectionDepth = 1;\n\n    stack.push(root);\n    while (stack.length > 0) {\n      // 1. pop tile\n      const tile = stack.pop();\n\n      // 2. check if tile needs to be refine, needs refine if a tile's LoD is not sufficient and tile has available children (available content)\n      let shouldRefine = false;\n      if (this.canTraverse(tile, frameState)) {\n        this.updateChildTiles(tile, frameState);\n        shouldRefine = this.updateAndPushChildren(\n          tile,\n          frameState,\n          stack,\n          tile.hasRenderContent ? tile._selectionDepth + 1 : tile._selectionDepth\n        );\n      }\n\n      // 3. decide if should render (select) this tile\n      //   - tile does not have render content\n      //   - tile has render content and tile is `add` type (pointcloud)\n      //   - tile has render content and tile is `replace` type (photogrammetry) and can't refine any further\n      const parent = tile.parent;\n      const parentRefines = Boolean(!parent || parent._shouldRefine);\n      const stoppedRefining = !shouldRefine;\n\n      if (!tile.hasRenderContent) {\n        this.emptyTiles[tile.id] = tile;\n        this.loadTile(tile, frameState);\n        if (stoppedRefining) {\n          this.selectTile(tile, frameState);\n        }\n        // additive tiles\n      } else if (tile.refine === TILE_REFINEMENT.ADD) {\n        // Additive tiles are always loaded and selected\n        this.loadTile(tile, frameState);\n        this.selectTile(tile, frameState);\n\n        // replace tiles\n      } else if (tile.refine === TILE_REFINEMENT.REPLACE) {\n        // Always load tiles in the base traversal\n        // Select tiles that can't refine further\n        this.loadTile(tile, frameState);\n        if (stoppedRefining) {\n          this.selectTile(tile, frameState);\n        }\n      }\n\n      // 3. update cache, most recent touched tiles have higher priority to be fetched from server\n      this.touchTile(tile, frameState);\n\n      // 4. update tile refine prop and parent refinement status to trickle down to the descendants\n      tile._shouldRefine = shouldRefine && parentRefines;\n    }\n\n    const newTime = new Date().getTime();\n    if (this.traversalFinished(frameState) || newTime - this.lastUpdate > this.updateDebounceTime) {\n      this.lastUpdate = newTime;\n      this.options.onTraversalEnd(frameState);\n    }\n  }\n\n  updateChildTiles(tile: Tile3D, frameState: FrameState): void {\n    const children = tile.children;\n    for (const child of children) {\n      this.updateTile(child, frameState);\n    }\n  }\n\n  /* eslint-disable complexity, max-statements */\n  updateAndPushChildren(tile: Tile3D, frameState: FrameState, stack, depth): boolean {\n    const {loadSiblings, skipLevelOfDetail} = this.options;\n\n    const children = tile.children;\n\n    // sort children tiles\n    children.sort(this.compareDistanceToCamera.bind(this));\n\n    // For traditional replacement refinement only refine if all children are loaded.\n    // Empty tiles are exempt since it looks better if children stream in as they are loaded to fill the empty space.\n    const checkRefines =\n      tile.refine === TILE_REFINEMENT.REPLACE && tile.hasRenderContent && !skipLevelOfDetail;\n\n    let hasVisibleChild = false;\n    let refines = true;\n\n    for (const child of children) {\n      child._selectionDepth = depth;\n      if (child.isVisibleAndInRequestVolume) {\n        if (stack.find(child)) {\n          stack.delete(child);\n        }\n        stack.push(child);\n        hasVisibleChild = true;\n      } else if (checkRefines || loadSiblings) {\n        // Keep non-visible children loaded since they are still needed before the parent can refine.\n        // Or loadSiblings is true so always load tiles regardless of visibility.\n        this.loadTile(child, frameState);\n        this.touchTile(child, frameState);\n      }\n\n      if (checkRefines) {\n        let childRefines;\n        if (!child._inRequestVolume) {\n          childRefines = false;\n        } else if (!child.hasRenderContent) {\n          childRefines = this.executeEmptyTraversal(child, frameState);\n        } else {\n          childRefines = child.contentAvailable;\n        }\n        refines = refines && childRefines;\n\n        if (!refines) {\n          return false;\n        }\n      }\n    }\n\n    if (!hasVisibleChild) {\n      refines = false;\n    }\n    return refines;\n  }\n  /* eslint-enable complexity, max-statements */\n\n  updateTile(tile: Tile3D, frameState: FrameState): void {\n    this.updateTileVisibility(tile, frameState);\n  }\n\n  // tile to render in the browser\n  selectTile(tile: Tile3D, frameState: FrameState): void {\n    if (this.shouldSelectTile(tile)) {\n      // The tile can be selected right away and does not require traverseAndSelect\n      tile._selectedFrame = frameState.frameNumber;\n      this.selectedTiles[tile.id] = tile;\n    }\n  }\n\n  // tile to load from server\n  loadTile(tile: Tile3D, frameState: FrameState): void {\n    if (this.shouldLoadTile(tile)) {\n      tile._requestedFrame = frameState.frameNumber;\n      tile._priority = tile._getPriority();\n      this.requestedTiles[tile.id] = tile;\n    }\n  }\n\n  // cache tile\n  touchTile(tile: Tile3D, frameState: FrameState): void {\n    tile.tileset._cache.touch(tile);\n    tile._touchedFrame = frameState.frameNumber;\n  }\n\n  // tile should be visible\n  // tile should have children\n  // tile LoD (level of detail) is not sufficient under current viewport\n  canTraverse(\n    tile: Tile3D,\n    frameState: FrameState,\n    useParentMetric: boolean = false,\n    ignoreVisibility: boolean = false\n  ): boolean {\n    if (!tile.hasChildren) {\n      return false;\n    }\n\n    // cesium specific\n    if (tile.hasTilesetContent) {\n      // Traverse external this to visit its root tile\n      // Don't traverse if the subtree is expired because it will be destroyed\n      return !tile.contentExpired;\n    }\n\n    if (!ignoreVisibility && !tile.isVisibleAndInRequestVolume) {\n      return false;\n    }\n\n    return this.shouldRefine(tile, frameState, useParentMetric);\n  }\n\n  shouldLoadTile(tile: Tile3D): boolean {\n    // if request tile is in current frame\n    // and has unexpired render content\n    return tile.hasUnloadedContent || tile.contentExpired;\n  }\n\n  shouldSelectTile(tile: Tile3D): boolean {\n    // if select tile is in current frame\n    // and content available\n    return tile.contentAvailable && !this.options.skipLevelOfDetail;\n  }\n\n  /** Decide if tile LoD (level of detail) is not sufficient under current viewport */\n  shouldRefine(tile: Tile3D, frameState: FrameState, useParentMetric: boolean = false): boolean {\n    let screenSpaceError = tile._screenSpaceError;\n    if (useParentMetric) {\n      screenSpaceError = tile.getScreenSpaceError(frameState, true);\n    }\n\n    return screenSpaceError > this.options.maximumScreenSpaceError;\n  }\n\n  updateTileVisibility(tile: Tile3D, frameState: FrameState): void {\n    const viewportIds: string[] = [];\n    if (this.options.viewportTraversersMap) {\n      for (const key in this.options.viewportTraversersMap) {\n        const value = this.options.viewportTraversersMap[key];\n        if (value === frameState.viewport.id) {\n          viewportIds.push(key);\n        }\n      }\n    } else {\n      viewportIds.push(frameState.viewport.id);\n    }\n    tile.updateVisibility(frameState, viewportIds);\n  }\n\n  // UTILITIES\n\n  compareDistanceToCamera(b: Tile3D, a: Tile3D): number {\n    return b._distanceToCamera - a._distanceToCamera;\n  }\n\n  anyChildrenVisible(tile: Tile3D, frameState: FrameState): boolean {\n    let anyVisible = false;\n    for (const child of tile.children) {\n      // @ts-expect-error\n      child.updateVisibility(frameState);\n      // @ts-expect-error\n      anyVisible = anyVisible || child.isVisibleAndInRequestVolume;\n    }\n    return anyVisible;\n  }\n\n  // Depth-first traversal that checks if all nearest descendants with content are loaded.\n  // Ignores visibility.\n  executeEmptyTraversal(root: Tile3D, frameState: FrameState): boolean {\n    let allDescendantsLoaded = true;\n    const stack = this._emptyTraversalStack;\n\n    stack.push(root);\n\n    while (stack.length > 0 && allDescendantsLoaded) {\n      const tile = stack.pop();\n\n      this.updateTile(tile, frameState);\n\n      if (!tile.isVisibleAndInRequestVolume) {\n        // Load tiles that aren't visible since they are still needed for the parent to refine\n        this.loadTile(tile, frameState);\n      }\n\n      this.touchTile(tile, frameState);\n\n      // Only traverse if the tile is empty - traversal stop at descendants with content\n      const traverse = !tile.hasRenderContent && this.canTraverse(tile, frameState, false, true);\n\n      if (traverse) {\n        const children = tile.children;\n        for (const child of children) {\n          // eslint-disable-next-line max-depth\n          if (stack.find(child)) {\n            stack.delete(child);\n          }\n          stack.push(child);\n        }\n      } else if (!tile.contentAvailable && !tile.hasEmptyContent) {\n        allDescendantsLoaded = false;\n      }\n    }\n\n    return allDescendantsLoaded;\n  }\n}\n"],"mappings":";;;;;;;;AAGA,IAAAA,aAAA,GAAAC,OAAA;AACA,IAAAC,UAAA,GAAAD,OAAA;AAaO,MAAME,aAA8C,GAAG;EAC5DC,YAAY,EAAE,KAAK;EACnBC,iBAAiB,EAAE,KAAK;EACxBC,uBAAuB,EAAE,CAAC;EAC1BC,gBAAgB,EAAE,IAAI;EACtBC,cAAc,EAAEA,CAAA,KAAM,CAAC,CAAC;EACxBC,qBAAqB,EAAE,CAAC,CAAC;EACzBC,QAAQ,EAAE;AACZ,CAAC;AAACC,OAAA,CAAAR,aAAA,GAAAA,aAAA;AAEK,MAAMS,gBAAgB,CAAC;EAsBlBC,iBAAiBA,CAACC,UAAsB,EAAW;IAC3D,OAAO,IAAI;EACb;EAGAC,WAAWA,CAACC,OAA8B,EAAE;IAAA,IAAAC,gBAAA,CAAAC,OAAA;IAAA,IAAAD,gBAAA,CAAAC,OAAA,gBAvBhC,IAAI;IAAA,IAAAD,gBAAA,CAAAC,OAAA,yBAGwB,CAAC,CAAC;IAAA,IAAAD,gBAAA,CAAAC,OAAA,0BAED,CAAC,CAAC;IAAA,IAAAD,gBAAA,CAAAC,OAAA,sBAEN,CAAC,CAAC;IAAA,IAAAD,gBAAA,CAAAC,OAAA,sBAER,IAAIC,IAAI,CAAC,CAAC,CAACC,OAAO,CAAC,CAAC;IAAA,IAAAH,gBAAA,CAAAC,OAAA,8BACX,IAAI;IAAA,IAAAD,gBAAA,CAAAC,OAAA,2BAEhB,IAAIG,0BAAY,CAAC,CAAC;IAAA,IAAAJ,gBAAA,CAAAC,OAAA,gCACb,IAAIG,0BAAY,CAAC,CAAC;IAAA,IAAAJ,gBAAA,CAAAC,OAAA,wBAEX,IAAI;IAS1C,IAAI,CAACF,OAAO,GAAG;MAAC,GAAGb,aAAa;MAAE,GAAGa;IAAO,CAAC;EAC/C;EAGAM,QAAQA,CAACC,IAAI,EAAET,UAAU,EAAEE,OAAO,EAAE;IAClC,IAAI,CAACO,IAAI,GAAGA,IAAI;IAChB,IAAI,CAACP,OAAO,GAAG;MAAC,GAAG,IAAI,CAACA,OAAO;MAAE,GAAGA;IAAO,CAAC;IAG5C,IAAI,CAACQ,KAAK,CAAC,CAAC;IAGZ,IAAI,CAACC,UAAU,CAACF,IAAI,EAAET,UAAU,CAAC;IAEjC,IAAI,CAACY,YAAY,GAAGZ,UAAU,CAACa,WAAW;IAC1C,IAAI,CAACC,gBAAgB,CAACL,IAAI,EAAET,UAAU,CAAC;EACzC;EAEAU,KAAKA,CAAA,EAAG;IACN,IAAI,CAACK,cAAc,GAAG,CAAC,CAAC;IACxB,IAAI,CAACC,aAAa,GAAG,CAAC,CAAC;IACvB,IAAI,CAACC,UAAU,GAAG,CAAC,CAAC;IACpB,IAAI,CAACC,eAAe,CAACR,KAAK,CAAC,CAAC;IAC5B,IAAI,CAACS,oBAAoB,CAACT,KAAK,CAAC,CAAC;EACnC;EAYAI,gBAAgBA,CAACL,IAAI,EAAET,UAAsB,EAAQ;IAGnD,MAAMoB,KAAK,GAAG,IAAI,CAACF,eAAe;IAClCT,IAAI,CAACY,eAAe,GAAG,CAAC;IAExBD,KAAK,CAACE,IAAI,CAACb,IAAI,CAAC;IAChB,OAAOW,KAAK,CAACG,MAAM,GAAG,CAAC,EAAE;MAEvB,MAAMC,IAAI,GAAGJ,KAAK,CAACK,GAAG,CAAC,CAAC;MAGxB,IAAIC,YAAY,GAAG,KAAK;MACxB,IAAI,IAAI,CAACC,WAAW,CAACH,IAAI,EAAExB,UAAU,CAAC,EAAE;QACtC,IAAI,CAAC4B,gBAAgB,CAACJ,IAAI,EAAExB,UAAU,CAAC;QACvC0B,YAAY,GAAG,IAAI,CAACG,qBAAqB,CACvCL,IAAI,EACJxB,UAAU,EACVoB,KAAK,EACLI,IAAI,CAACM,gBAAgB,GAAGN,IAAI,CAACH,eAAe,GAAG,CAAC,GAAGG,IAAI,CAACH,eAC1D,CAAC;MACH;MAMA,MAAMU,MAAM,GAAGP,IAAI,CAACO,MAAM;MAC1B,MAAMC,aAAa,GAAGC,OAAO,CAAC,CAACF,MAAM,IAAIA,MAAM,CAACG,aAAa,CAAC;MAC9D,MAAMC,eAAe,GAAG,CAACT,YAAY;MAErC,IAAI,CAACF,IAAI,CAACM,gBAAgB,EAAE;QAC1B,IAAI,CAACb,UAAU,CAACO,IAAI,CAACY,EAAE,CAAC,GAAGZ,IAAI;QAC/B,IAAI,CAACa,QAAQ,CAACb,IAAI,EAAExB,UAAU,CAAC;QAC/B,IAAImC,eAAe,EAAE;UACnB,IAAI,CAACG,UAAU,CAACd,IAAI,EAAExB,UAAU,CAAC;QACnC;MAEF,CAAC,MAAM,IAAIwB,IAAI,CAACe,MAAM,KAAKC,0BAAe,CAACC,GAAG,EAAE;QAE9C,IAAI,CAACJ,QAAQ,CAACb,IAAI,EAAExB,UAAU,CAAC;QAC/B,IAAI,CAACsC,UAAU,CAACd,IAAI,EAAExB,UAAU,CAAC;MAGnC,CAAC,MAAM,IAAIwB,IAAI,CAACe,MAAM,KAAKC,0BAAe,CAACE,OAAO,EAAE;QAGlD,IAAI,CAACL,QAAQ,CAACb,IAAI,EAAExB,UAAU,CAAC;QAC/B,IAAImC,eAAe,EAAE;UACnB,IAAI,CAACG,UAAU,CAACd,IAAI,EAAExB,UAAU,CAAC;QACnC;MACF;MAGA,IAAI,CAAC2C,SAAS,CAACnB,IAAI,EAAExB,UAAU,CAAC;MAGhCwB,IAAI,CAACU,aAAa,GAAGR,YAAY,IAAIM,aAAa;IACpD;IAEA,MAAMY,OAAO,GAAG,IAAIvC,IAAI,CAAC,CAAC,CAACC,OAAO,CAAC,CAAC;IACpC,IAAI,IAAI,CAACP,iBAAiB,CAACC,UAAU,CAAC,IAAI4C,OAAO,GAAG,IAAI,CAACC,UAAU,GAAG,IAAI,CAACC,kBAAkB,EAAE;MAC7F,IAAI,CAACD,UAAU,GAAGD,OAAO;MACzB,IAAI,CAAC1C,OAAO,CAACR,cAAc,CAACM,UAAU,CAAC;IACzC;EACF;EAEA4B,gBAAgBA,CAACJ,IAAY,EAAExB,UAAsB,EAAQ;IAC3D,MAAM+C,QAAQ,GAAGvB,IAAI,CAACuB,QAAQ;IAC9B,KAAK,MAAMC,KAAK,IAAID,QAAQ,EAAE;MAC5B,IAAI,CAACpC,UAAU,CAACqC,KAAK,EAAEhD,UAAU,CAAC;IACpC;EACF;EAGA6B,qBAAqBA,CAACL,IAAY,EAAExB,UAAsB,EAAEoB,KAAK,EAAE6B,KAAK,EAAW;IACjF,MAAM;MAAC3D,YAAY;MAAEC;IAAiB,CAAC,GAAG,IAAI,CAACW,OAAO;IAEtD,MAAM6C,QAAQ,GAAGvB,IAAI,CAACuB,QAAQ;IAG9BA,QAAQ,CAACG,IAAI,CAAC,IAAI,CAACC,uBAAuB,CAACC,IAAI,CAAC,IAAI,CAAC,CAAC;IAItD,MAAMC,YAAY,GAChB7B,IAAI,CAACe,MAAM,KAAKC,0BAAe,CAACE,OAAO,IAAIlB,IAAI,CAACM,gBAAgB,IAAI,CAACvC,iBAAiB;IAExF,IAAI+D,eAAe,GAAG,KAAK;IAC3B,IAAIC,OAAO,GAAG,IAAI;IAElB,KAAK,MAAMP,KAAK,IAAID,QAAQ,EAAE;MAC5BC,KAAK,CAAC3B,eAAe,GAAG4B,KAAK;MAC7B,IAAID,KAAK,CAACQ,2BAA2B,EAAE;QACrC,IAAIpC,KAAK,CAACqC,IAAI,CAACT,KAAK,CAAC,EAAE;UACrB5B,KAAK,CAACsC,MAAM,CAACV,KAAK,CAAC;QACrB;QACA5B,KAAK,CAACE,IAAI,CAAC0B,KAAK,CAAC;QACjBM,eAAe,GAAG,IAAI;MACxB,CAAC,MAAM,IAAID,YAAY,IAAI/D,YAAY,EAAE;QAGvC,IAAI,CAAC+C,QAAQ,CAACW,KAAK,EAAEhD,UAAU,CAAC;QAChC,IAAI,CAAC2C,SAAS,CAACK,KAAK,EAAEhD,UAAU,CAAC;MACnC;MAEA,IAAIqD,YAAY,EAAE;QAChB,IAAIM,YAAY;QAChB,IAAI,CAACX,KAAK,CAACY,gBAAgB,EAAE;UAC3BD,YAAY,GAAG,KAAK;QACtB,CAAC,MAAM,IAAI,CAACX,KAAK,CAAClB,gBAAgB,EAAE;UAClC6B,YAAY,GAAG,IAAI,CAACE,qBAAqB,CAACb,KAAK,EAAEhD,UAAU,CAAC;QAC9D,CAAC,MAAM;UACL2D,YAAY,GAAGX,KAAK,CAACc,gBAAgB;QACvC;QACAP,OAAO,GAAGA,OAAO,IAAII,YAAY;QAEjC,IAAI,CAACJ,OAAO,EAAE;UACZ,OAAO,KAAK;QACd;MACF;IACF;IAEA,IAAI,CAACD,eAAe,EAAE;MACpBC,OAAO,GAAG,KAAK;IACjB;IACA,OAAOA,OAAO;EAChB;EAGA5C,UAAUA,CAACa,IAAY,EAAExB,UAAsB,EAAQ;IACrD,IAAI,CAAC+D,oBAAoB,CAACvC,IAAI,EAAExB,UAAU,CAAC;EAC7C;EAGAsC,UAAUA,CAACd,IAAY,EAAExB,UAAsB,EAAQ;IACrD,IAAI,IAAI,CAACgE,gBAAgB,CAACxC,IAAI,CAAC,EAAE;MAE/BA,IAAI,CAACyC,cAAc,GAAGjE,UAAU,CAACa,WAAW;MAC5C,IAAI,CAACG,aAAa,CAACQ,IAAI,CAACY,EAAE,CAAC,GAAGZ,IAAI;IACpC;EACF;EAGAa,QAAQA,CAACb,IAAY,EAAExB,UAAsB,EAAQ;IACnD,IAAI,IAAI,CAACkE,cAAc,CAAC1C,IAAI,CAAC,EAAE;MAC7BA,IAAI,CAAC2C,eAAe,GAAGnE,UAAU,CAACa,WAAW;MAC7CW,IAAI,CAAC4C,SAAS,GAAG5C,IAAI,CAAC6C,YAAY,CAAC,CAAC;MACpC,IAAI,CAACtD,cAAc,CAACS,IAAI,CAACY,EAAE,CAAC,GAAGZ,IAAI;IACrC;EACF;EAGAmB,SAASA,CAACnB,IAAY,EAAExB,UAAsB,EAAQ;IACpDwB,IAAI,CAAC8C,OAAO,CAACC,MAAM,CAACC,KAAK,CAAChD,IAAI,CAAC;IAC/BA,IAAI,CAACiD,aAAa,GAAGzE,UAAU,CAACa,WAAW;EAC7C;EAKAc,WAAWA,CACTH,IAAY,EACZxB,UAAsB,EAGb;IAAA,IAFT0E,eAAwB,GAAAC,SAAA,CAAApD,MAAA,QAAAoD,SAAA,QAAAC,SAAA,GAAAD,SAAA,MAAG,KAAK;IAAA,IAChCE,gBAAyB,GAAAF,SAAA,CAAApD,MAAA,QAAAoD,SAAA,QAAAC,SAAA,GAAAD,SAAA,MAAG,KAAK;IAEjC,IAAI,CAACnD,IAAI,CAACsD,WAAW,EAAE;MACrB,OAAO,KAAK;IACd;IAGA,IAAItD,IAAI,CAACuD,iBAAiB,EAAE;MAG1B,OAAO,CAACvD,IAAI,CAACwD,cAAc;IAC7B;IAEA,IAAI,CAACH,gBAAgB,IAAI,CAACrD,IAAI,CAACgC,2BAA2B,EAAE;MAC1D,OAAO,KAAK;IACd;IAEA,OAAO,IAAI,CAAC9B,YAAY,CAACF,IAAI,EAAExB,UAAU,EAAE0E,eAAe,CAAC;EAC7D;EAEAR,cAAcA,CAAC1C,IAAY,EAAW;IAGpC,OAAOA,IAAI,CAACyD,kBAAkB,IAAIzD,IAAI,CAACwD,cAAc;EACvD;EAEAhB,gBAAgBA,CAACxC,IAAY,EAAW;IAGtC,OAAOA,IAAI,CAACsC,gBAAgB,IAAI,CAAC,IAAI,CAAC5D,OAAO,CAACX,iBAAiB;EACjE;EAGAmC,YAAYA,CAACF,IAAY,EAAExB,UAAsB,EAA6C;IAAA,IAA3C0E,eAAwB,GAAAC,SAAA,CAAApD,MAAA,QAAAoD,SAAA,QAAAC,SAAA,GAAAD,SAAA,MAAG,KAAK;IACjF,IAAIO,gBAAgB,GAAG1D,IAAI,CAAC2D,iBAAiB;IAC7C,IAAIT,eAAe,EAAE;MACnBQ,gBAAgB,GAAG1D,IAAI,CAAC4D,mBAAmB,CAACpF,UAAU,EAAE,IAAI,CAAC;IAC/D;IAEA,OAAOkF,gBAAgB,GAAG,IAAI,CAAChF,OAAO,CAACV,uBAAuB;EAChE;EAEAuE,oBAAoBA,CAACvC,IAAY,EAAExB,UAAsB,EAAQ;IAC/D,MAAMqF,WAAqB,GAAG,EAAE;IAChC,IAAI,IAAI,CAACnF,OAAO,CAACP,qBAAqB,EAAE;MACtC,KAAK,MAAM2F,GAAG,IAAI,IAAI,CAACpF,OAAO,CAACP,qBAAqB,EAAE;QACpD,MAAM4F,KAAK,GAAG,IAAI,CAACrF,OAAO,CAACP,qBAAqB,CAAC2F,GAAG,CAAC;QACrD,IAAIC,KAAK,KAAKvF,UAAU,CAACwF,QAAQ,CAACpD,EAAE,EAAE;UACpCiD,WAAW,CAAC/D,IAAI,CAACgE,GAAG,CAAC;QACvB;MACF;IACF,CAAC,MAAM;MACLD,WAAW,CAAC/D,IAAI,CAACtB,UAAU,CAACwF,QAAQ,CAACpD,EAAE,CAAC;IAC1C;IACAZ,IAAI,CAACiE,gBAAgB,CAACzF,UAAU,EAAEqF,WAAW,CAAC;EAChD;EAIAlC,uBAAuBA,CAACuC,CAAS,EAAEC,CAAS,EAAU;IACpD,OAAOD,CAAC,CAACE,iBAAiB,GAAGD,CAAC,CAACC,iBAAiB;EAClD;EAEAC,kBAAkBA,CAACrE,IAAY,EAAExB,UAAsB,EAAW;IAChE,IAAI8F,UAAU,GAAG,KAAK;IACtB,KAAK,MAAM9C,KAAK,IAAIxB,IAAI,CAACuB,QAAQ,EAAE;MAEjCC,KAAK,CAACyC,gBAAgB,CAACzF,UAAU,CAAC;MAElC8F,UAAU,GAAGA,UAAU,IAAI9C,KAAK,CAACQ,2BAA2B;IAC9D;IACA,OAAOsC,UAAU;EACnB;EAIAjC,qBAAqBA,CAACpD,IAAY,EAAET,UAAsB,EAAW;IACnE,IAAI+F,oBAAoB,GAAG,IAAI;IAC/B,MAAM3E,KAAK,GAAG,IAAI,CAACD,oBAAoB;IAEvCC,KAAK,CAACE,IAAI,CAACb,IAAI,CAAC;IAEhB,OAAOW,KAAK,CAACG,MAAM,GAAG,CAAC,IAAIwE,oBAAoB,EAAE;MAC/C,MAAMvE,IAAI,GAAGJ,KAAK,CAACK,GAAG,CAAC,CAAC;MAExB,IAAI,CAACd,UAAU,CAACa,IAAI,EAAExB,UAAU,CAAC;MAEjC,IAAI,CAACwB,IAAI,CAACgC,2BAA2B,EAAE;QAErC,IAAI,CAACnB,QAAQ,CAACb,IAAI,EAAExB,UAAU,CAAC;MACjC;MAEA,IAAI,CAAC2C,SAAS,CAACnB,IAAI,EAAExB,UAAU,CAAC;MAGhC,MAAMQ,QAAQ,GAAG,CAACgB,IAAI,CAACM,gBAAgB,IAAI,IAAI,CAACH,WAAW,CAACH,IAAI,EAAExB,UAAU,EAAE,KAAK,EAAE,IAAI,CAAC;MAE1F,IAAIQ,QAAQ,EAAE;QACZ,MAAMuC,QAAQ,GAAGvB,IAAI,CAACuB,QAAQ;QAC9B,KAAK,MAAMC,KAAK,IAAID,QAAQ,EAAE;UAE5B,IAAI3B,KAAK,CAACqC,IAAI,CAACT,KAAK,CAAC,EAAE;YACrB5B,KAAK,CAACsC,MAAM,CAACV,KAAK,CAAC;UACrB;UACA5B,KAAK,CAACE,IAAI,CAAC0B,KAAK,CAAC;QACnB;MACF,CAAC,MAAM,IAAI,CAACxB,IAAI,CAACsC,gBAAgB,IAAI,CAACtC,IAAI,CAACwE,eAAe,EAAE;QAC1DD,oBAAoB,GAAG,KAAK;MAC9B;IACF;IAEA,OAAOA,oBAAoB;EAC7B;AACF;AAAClG,OAAA,CAAAC,gBAAA,GAAAA,gBAAA"}